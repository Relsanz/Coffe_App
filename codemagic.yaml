workflows:
  flutter_build:
    name: Flutter Build
    instance_type: mac_mini_m1
    max_build_duration: 120
    environment:
      flutter: stable
      java: 11  # Gunakan JDK 11 agar kompatibel dengan Gradle 7.5.1
    scripts:
      - name: Check Java Version
        script: |
          echo "JAVA_HOME: $JAVA_HOME"
          java -version

      - name: Set JAVA_HOME (JDK 11)
        script: |
          export JAVA_HOME=$(/usr/libexec/java_home -v 11)
          echo "Using JAVA_HOME: $JAVA_HOME"

      - name: Debug Build Path
        script: |
          echo "Current directory: $(pwd)"
          ls -la  # Menampilkan isi folder untuk memastikan pubspec.yaml ada

      - name: Run Flutter Doctor
        script: |
          flutter doctor -v

      - name: Clean Build
        script: |
          cd $CM_BUILD_DIR
          ls -la  # Cek apakah pubspec.yaml ada di root
          flutter clean

      - name: Get Flutter Dependencies
        script: |
          cd $CM_BUILD_DIR
          flutter pub get

      - name: Run Gradle Manually (Debugging)
        script: |
          cd $CM_BUILD_DIR/android
          ./gradlew assembleRelease --stacktrace

      - name: Build APK
        script: |
          cd $CM_BUILD_DIR
          flutter build apk --release --verbose

    artifacts:
      - build/app/outputs/flutter-apk/*.apk
